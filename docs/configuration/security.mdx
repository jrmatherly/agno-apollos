---
title: "Security"
description: "Microsoft Entra ID authentication, RBAC authorization, and approval-gated tools."
---

Apollos AI supports opt-in Microsoft Entra ID authentication, role-based authorization, and human-in-the-loop approval workflows.

## Authentication

Authentication is disabled by default. When `AZURE_TENANT_ID`, `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`, and `AZURE_AUDIENCE` are all set, the backend validates RS256 JWTs issued by Microsoft Entra ID.

### How it works

1. Azure Entra ID issues JWT access tokens signed with RS256
2. `EntraJWTMiddleware` validates tokens via JWKS discovery (fetched from Entra's OIDC endpoint)
3. App Roles in the token map to Agno scope strings for per-route authorization
4. The frontend uses MSAL.js v5 to sign users in and silently refresh tokens every 5 minutes

### Configuration

```bash
# .env (backend)
AZURE_TENANT_ID=<Directory (tenant) ID>
AZURE_CLIENT_ID=<Application (client) ID>
AZURE_CLIENT_SECRET=<Client secret value>
AZURE_AUDIENCE=api://<Application (client) ID>
FRONTEND_URL=http://localhost:3000

# .env (frontend, baked at build time)
NEXT_PUBLIC_AZURE_CLIENT_ID=<Application (client) ID>
NEXT_PUBLIC_AZURE_TENANT_ID=<Directory (tenant) ID>
NEXT_PUBLIC_REDIRECT_URI=http://localhost:3000
```

When any of the four `AZURE_*` values is empty, auth is disabled and all requests pass through.

<Note>
**Single-app registration audience:** When the SPA client and API resource share one Azure App Registration, Azure issues access tokens with `aud = {AZURE_CLIENT_ID}` (bare GUID) instead of `api://{AZURE_CLIENT_ID}`, even when `accessTokenAcceptedVersion: 2` is set in the manifest. The backend accepts both forms. Keep `AZURE_AUDIENCE=api://{AZURE_CLIENT_ID}` in your `.env`.
</Note>

### Azure App Registration requirements

The following must be configured in your Azure App Registration before auth will work:

| Setting | Location | Value |
|---------|----------|-------|
| Platform | Authentication | Single-page application (SPA) |
| Redirect URI | Authentication | `http://localhost:3000` (or your frontend URL) |
| Access tokens | Authentication | Enable (for implicit flow) |
| `accessTokenAcceptedVersion` | Manifest | `2` |
| App Roles | App roles | `GlobalAdmin`, `Admin`, `TeamLead`, `Developer`, `DevOps`, `InfoSec`, `User` |
| Expose an API | Expose an API | `api://{AZURE_CLIENT_ID}` with `access_as_user` delegated scope |
| API permissions | API permissions | `User.Read` (Microsoft Graph, delegated) |

Assign users or groups to App Roles under **Enterprise Applications → Your App → Users and groups**. Users with no assigned role receive 403 on protected endpoints.

### App Roles and Scopes

Create App Roles in Azure and assign users. The role value in the token maps to Agno scopes:

| Azure App Role | Key Agno Scopes |
|----------------|----------------|
| `GlobalAdmin` | `agent_os:admin` (full bypass) |
| `Admin` | Full CRUD across all resources |
| `TeamLead` | Run agents, manage sessions and memories |
| `Developer` | Read agents, run, manage own sessions |
| `DevOps` | Metrics, traces, schedules |
| `InfoSec` | Read-only across all resources |
| `User` | Basic agent access |

### Auth API endpoints

| Endpoint | Auth Required | Description |
|----------|---------------|-------------|
| `GET /auth/health` | No | Auth status check |
| `GET /auth/me` | Yes | Current user: OID, email, roles, scopes |
| `POST /auth/sync` | Yes | Trigger on-demand group sync |
| `GET /auth/teams` | Yes (`teams:read`) | List active teams |
| `GET /auth/users` | Yes (`agent_os:admin`) | List all synced users |

### Debugging 401 errors

Set `AUTH_DEBUG=True` to enable diagnostic logging for all 401 responses:

```bash
# .env (or mise.toml for dev)
AUTH_DEBUG=True
```

The middleware logs the reason for each 401, including the actual `aud` value on audience mismatches:

```
WARNING 401 Invalid audience: GET /agents - token aud='4837d7c1-...', expected AZURE_AUDIENCE=api://4837d7c1-...
WARNING 401 Missing token: GET /agents (no Authorization: Bearer header)
WARNING 401 Expired token: GET /teams
```

`AUTH_DEBUG` defaults to `True` in development and `False` in production.

### Local development

With empty `AZURE_*` vars, the backend accepts all requests. No configuration needed for local development.

To test specific role behaviors locally:

```bash
mise run auth:generate-token
```

This generates a signed test JWT with the specified role for use with curl or the frontend.

## Approval workflows

Certain tools require human approval before execution. These use Agno's `@approval` decorator:

```python
from agno.approval import approval
from agno.tools import tool

@tool
@approval
def add_knowledge_source(url: str, name: str) -> str:
    """Add an external URL to the knowledge base."""
    # Executes only after human approval
    return f"Knowledge source '{name}' from {url} queued for loading"
```

The decorator order matters: `@tool` must come before `@approval`.

## Approval types

| Type | Decorator | Description |
|------|-----------|-------------|
| Standard | `@approval` | Requires explicit human approval (auto-sets `requires_confirmation`) |
| Audit | `@approval(type="audit")` | Logs the action for audit trail |

For the audit type, you must explicitly set a HITL flag on `@tool()`:

```python
@tool(requires_confirmation=True)
@approval(type="audit")
def export_session_data(session_id: str, format: str = "json") -> str:
    """Export session data with audit logging."""
    return f"Session {session_id} exported as {format}"
```

The standard `@approval` type auto-sets `requires_confirmation=True` if no flag is provided. The audit type requires an explicit choice.

## Guardrails

All agents include security guardrails via `pre_hooks`:

```python
from agno.guardrails import PIIDetectionGuardrail, PromptInjectionGuardrail

agent = Agent(
    pre_hooks=[PIIDetectionGuardrail(mask_pii=False), PromptInjectionGuardrail()],
)
```

| Guardrail | Purpose |
|-----------|---------|
| `PIIDetectionGuardrail` | Detects personally identifiable information in messages |
| `PromptInjectionGuardrail` | Blocks prompt injection attempts |

These run before the agent processes each message. `mask_pii=False` flags PII without masking it (set to `True` to automatically redact).
